<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Numérica</title>
</head>
<body>
    <h1>Calculadora Numérica</h1>

    <label for="metodo">Escolha o método:</label>
    <select id="metodo">
        <option value="newton">Newton-Raphson</option>
        <option value="secante">Secante</option>
        <option value="bisseccao">Bissecção</option>
        <option value="falsa_posicao">Falsa Posição</option>
        <option value="todos">Calcular com todos os métodos</option>
    </select><br>

    <label for="funcao">Digite a função:</label>
    <input type="text" id="funcao" placeholder="x**3 - 2*x - 5"><br>

    <label for="x0">Valor inicial (x0):</label>
    <input type="number" id="x0" step="any"><br>

    <label for="x1" id="x1-label">Valor inicial (x1) (para secante/bissecção/falsa posição):</label>
    <input type="number" id="x1" step="any"><br>

    <label for="tol">Digite a tolerância:</label>
    <input type="number" id="tol" step="any" value="0.001"><br>

    <label for="max_iter">Digite a quantidade máxima de iterações:</label>
    <input type="number" id="max_iter" value="100"><br>

    <label>
        <input type="checkbox" id="use-resultado-antigo">Usar resultado anterior
    </label>
    <input type="hidden" id="resultado-anterior">
    <br>  

    <button onclick="calcular()">Calcular</button>

    <div id="resultados"></div>
    <div id="erros" style="color: red;"></div>

    <script>
    function calcular() {

        //Transformar os ID's em váriaveis
        const metodo = document.getElementById("metodo").value;
        const funcao = document.getElementById("funcao").value;
        const x0 = document.getElementById("x0").value;
        const x1 = document.getElementById("x1").value;
        const tol = document.getElementById("tol").value;
        const max_iter = document.getElementById("max_iter").value;

        //Validação
        if (!funcao || !x0 || !tol || !max_iter) {
            document.getElementById("erros").innerHTML = "Por favor, preencha todos os campos obrigatórios.";
            return;
        }
        
        //Corpo do objeto
        const bodyData = { 
            metodo, 
            funcao, 
            x0: parseFloat(x0), 
            tol: parseFloat(tol), 
            max_iter: parseInt(max_iter)
        };

        if (metodo !== "newton") {
            bodyData.x1 = x1 ? parseFloat(x1) : null; // x1 é obrigatório para alguns métodos
        }

        //Envio dos dados para o calculo.js
        fetch("/calcular", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
        })

        //Recebimento da resposta do main.py
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao calcular: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
    if (data.error) {

        //Erro
        document.getElementById("erros").innerHTML = 'Erro: ' + data.error;
    } else {
        let resultadosHtml = '<h3>Resultados:</h3>';
        if (metodo === 'todos') {

            // Exibe o gráfico
            for (const [key, value] of Object.entries(data)) {
                resultadosHtml += `<div class="result-container">
                                    <h2>${key.replace('_', ' ').toUpperCase()}</h2>
                                    <p>Resultado: ${value.resultado}</p>
                                    <img src="${value.grafico_url}" alt="Gráfico ${key.replace('_', ' ')}">`;

                // Verifica se iteracoes existem
                if (value.iteracoes && value.iteracoes.length > 0) {
                         //<table>
                           //<thead>
                                //<tr>
                                    //<th>Iteração</th>
                                    //<th>x</th>
                                    //<th>f(x)</th>
                                    //<th>Diferença</th>
                                //</tr>
                            //</thead>
                           //<tbody>
                          //</tbody>
                        //</table>

                    //Montagem do cabeçalho da tabela
                    resultadosHtml += '<table><thead><tr><th>Iteração</th><th>x</th><th>f(x)</th><th>Diferença</th></tr></thead><tbody>';
 
                    value.iteracoes.forEach(iteracao => {
                        
                        //Montagem dos dados da tabela
                        resultadosHtml += `<tr>
                                              <td>${iteracao.iteracao}</td>
                                              <td>${iteracao.x}</td>
                                              <td>${iteracao.f_x}</td>
                                              <td>${iteracao.diferenca}</td>
                                           </tr>`;
                    });

                    // Finalização
                    resultadosHtml += '</tbody></table></div>';
                } else {

                    //Erro
                    resultadosHtml += '<p>Nenhuma iteração disponível.</p>';
                }
            }
        } else {
            
            //Cabeçalho
            resultadosHtml += `<h2>${metodo.replace('_', ' ').toUpperCase()}</h2>
                               <p>Resultado: ${data[metodo].resultado}</p>
                               <img src="${data[metodo].grafico_url}" alt="Gráfico ${metodo.replace('_', ' ')}">`;

            // Verifica se iteracoes existe
            if (data[metodo].iteracoes && data[metodo].iteracoes.length > 0) {

                //Montagem da tabela
                resultadosHtml += '<table><thead><tr><th>Iteração</th><th>x</th><th>f(x)</th><th>Diferença</th></tr></thead><tbody>';
                data[metodo].iteracoes.forEach(iteracao => {

                    //Montagem dos dados da tabela
                    resultadosHtml += `<tr>
                                          <td>${iteracao.iteracao}</td>
                                          <td>${iteracao.x}</td>
                                          <td>${iteracao.f_x}</td>
                                          <td>${iteracao.diferenca}</td>
                                       </tr>`;
                });

                // Finalização
                resultadosHtml += '</tbody></table>';
            } else {

                //Erro
                resultadosHtml += '<p>Nenhuma iteração disponível.</p>';
            }
        }

        //Construção do conteúdo concluida e atualização da interface
        document.getElementById("resultados").innerHTML = resultadosHtml;

        //Coleta do gráfico e atualização da fonte da imagem
        const graficoImg = document.getElementById('grafico');
        if (graficoImg && data[metodo] && data[metodo].grafico_url) {
            graficoImg.src = data[metodo].grafico_url;
        }
    }
})
.catch(error => {
    //Erro
    document.getElementById("erros").innerHTML = 'Erro no cálculo: ' + error.message;
});
    }
    </script>
</body>
</html>
